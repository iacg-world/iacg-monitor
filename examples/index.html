<!DOCTYPE html>
<html>
  <head>
    <title>iacg-cli监控测试</title>
    <meta charset="utf-8" />
    <meta iacg-app-id="a123456" />
    <script>
      function addDom() {
        const body = document.body
        const div = document.createElement('div')
        div.innerHTML = 'iacg监控SDK'
        div.style = 'background-color: red'
        div.className = 'new-dom'
        div.setAttribute('appear', '')
        body.insertBefore(div, body.firstChild)
        window.IacgCliMonitor.collectAppear() // 刷新appear监听列表
      }

      function onJump(e) {
        console.log('mod-id', e.getAttribute('iacg-mod-id'))
        window.IacgCliMonitor.sendClick(
          {
            jumpUrl: 'https://www.baidu.com',
          },
          { target: e },
        )
      }

      function jump() {
        const dom = document.querySelector('.jump')
        window.location.href = 'https://www.qq.com'
        window.IacgCliMonitor.sendClick({
          jumpUrl: 'https://www.qq.com',
          target: dom.className,
        })
      }
    </script>
  </head>
  <body iacg-page-id="b123456">
    <a
      href="https://www.baidu.com"
      onClick="onJump(this)"
      iacg-mod-id="jump-to-baidu"
    >
      跳转到baidu
    </a>
    <div class="jump" onClick="jump()">跳转到腾讯</div>
    <!-- 曝光埋点：由不可见变为可见（最初未渲染） -->
    <button onClick="addDom()" class="addDom">点我添加DOM</button>
    <div style="height: 2000px; background-color: red"></div>
    <!-- 曝光埋点：由不可见变为可见（渲染未显示） -->
    <div
      class="demo2"
      style="height: 100px; background-color: yellow"
      appear
      iacg-mod-id="c123456"
    ></div>
    <!-- <script>
  (function() {
    const script = document.createElement('script');
    // script.src = 'https://iacg.youbaobao.xyz/iacg-cli-monitor.js';
    script.src = '../iacg-cli-monitor/dist/iacg-cli-monitor.js';
    const body = document.body;
    body.insertBefore(script, body.firstChild);
    script.onload = function() {
      var event = new CustomEvent('onMonitorScriptLoad');
      window.dispatchEvent(event);
    }
  })();
</script> -->
    <script>
      // throw new Error('error from script');
      // Promise.resolve(() => {
      //   return { a: 1 };
      // }).then(res => {
      //   throw new Error('error from promise');
      // });
      document
        .getElementsByClassName('demo2')[0]
        .addEventListener('onAppear', function (e) {
          window.IacgCliMonitor.sendExp({ a: 1, b: 2 }, e)
        })
      window.addEventListener('load', function () {
        const m = window.IacgCliMonitor
        m.registerBeforeCreateParams(function () {
          console.log('before create params')
        })
        m.registerBeforeUpload(function (params) {
          return params + '&custom=1'
        })
        m.registerAfterUpload(function (url, data) {
          console.log(url, data)
        })
        m.registerOnError(function (e) {
          console.log('Erorr!' + e.message)
        })
        m.sendPV()
      })
      window.addEventListener('load', function () {
        // 性能指标获取
        // const timing = window.performance.getEntriesByType('paint');
        // timing.forEach(entry => console.log(entry));
        // 性能采集：PerformanceTiming
        // 问题：
        // 1. 精度不足，精度只能达到毫秒级别
        // 2. 时机不容易把握，如：无法知道load事件何时结束
        // const timing = window.performance.timing;
        // window.performance.mark('onload');
      })
      // function callback(perf) {
      //   perf.getEntries().forEach(timing => {
      //     console.log(timing);
      //     if (timing.entryType === 'navigation') {
      //       const dns = timing.domainLookupEnd - timing.domainLookupStart;
      //       const tcp = timing.connectEnd - timing.connectStart;
      //       const http = timing.responseEnd - timing.requestStart;
      //       const dom = timing.domComplete - timing.domInteractive;
      //       const load = timing.loadEventEnd - timing.loadEventStart;
      //       console.log('dns', dns);
      //       console.log('tcp', tcp);
      //       console.log('http', http);
      //       console.log('dom', dom);
      //       console.log('load', load);
      //     }
      //   });
      // }
      //
      // const observer = new PerformanceObserver(callback);
      // observer.observe({
      //   entryTypes: ['paint', 'largest-contentful-paint', 'mark'],
      // });
    </script>
  </body>
</html>
